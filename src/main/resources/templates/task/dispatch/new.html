<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>新增分发任务 - 欧司朗视频切割系统</title>
    <link rel="stylesheet" href="{{ctx.contextPath}}/css/bootstrap.css">
    <!--[if lt IE 9]>
    <script src="{{ctx.contextPath}}/js/vendor/html5shiv.min.js"></script>
    <script src="{{ctx.contextPath}}/js/vendor/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" href="{{ctx.contextPath}}/css/jquery.fileupload.css">
    <link rel="stylesheet" href="{{ctx.contextPath}}/css/bijie.css">
    <style></style>
</head>

<body>

<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container-fluid">
        <div class="navbar-header">
            <a class="navbar-brand" href="#">欧司朗视频切割系统</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
                <li><a target="blank" href="{{ctx.contextPath}}/admin/login">高级设置</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container-fluid">
    <div class="row">
        <div class="col-sm-3 col-md-2 sidebar">
            <ul class="nav nav-sidebar">
                <li class="active submenu open">
                    <a href="#">任务管理</a>
                    <ul style="display: block;">
                        <li><a href="{{ctx.contextPath}}/task/split/list">切割任务</a></li>
                        <li class="active"><a href="{{ctx.contextPath}}/task/dispatch/list">分发任务</a></li>
                        <li><a href="{{ctx.contextPath}}/task/realplay/list">实时文件播放任务</a></li>
                    </ul>
                </li>
                <li><a href="{{ctx.contextPath}}/manage/sub_system/list">通用管理</a></li>
            </ul>
        </div>

        <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
            {{#message}}
            <p class="alert {{#hasError}}alert-danger{{/hasError}}{{^hasError}}alert-success{{/hasError}}" role="alert">
            	<a href="#" class="close" data-dismiss="alert">&times;</a><em>系统提示：</em>{{message}}</p>
            {{/message}}
            <div class="page-header">
                <h1>分发任务
                    <small>新增</small>
                </h1>
            </div>
            <form class="form-horizontal" method="post" id="form" enctype="multipart/form-data" onsubmit="return onSubmit()">
                <div class="form-group">
                    <label for="inputCode" class="col-sm-2 control-label">任务名称</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control"  name="taskName" placeholder="任务名称" value="{{#dispatchTask}}{{#taskName}}{{.}}{{/taskName}}{{/dispatchTask}}"  required>
                        {{#taskNameErr}}<span class="error">{{.}}</span>{{/taskNameErr}}
                    </div>
                </div>
                <div class="form-group">
                    <label for="inputName" class="col-sm-2 control-label">选择切割任务</label>
                    <div class="col-sm-10">
                        <select class="form-control" name="splitTask.id" id="splitTaskId" onchange="changeSplitTask()" required>
                        	{{#splitTasks}}
                        	<option value="{{id}}">{{taskName}}</option>
                        	{{/splitTasks}}
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="inputName" class="col-sm-2 control-label">选择分发区域</label>
                    <div class="col-sm-10">
                        <div class="table-responsive">
			                <table class="table table-striped">
			                    <thead>
			                    <tr>
			                        <th>&nbsp;</th>
			                        <th>ECUE主机</th>
			                        <th>文件名称</th>
			                        <th>切割状态</th>
			                        <th>区域宽度</th>
			                        <th>区域高度</th>
			                    </tr>
			                    </thead>
			                    <tbody id="subTask_div"></tbody>
			                </table>
			            </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="inputCode" class="col-sm-2 control-label">任务密码</label>
                    <div class="col-sm-10">
                        <input type="password" class="form-control"  name="taskPassword" placeholder="任务密码" required>
                        {{#taskPasswordErr}}<span class="error">{{.}}</span>{{/taskPasswordErr}}
                    </div>
                </div>
                <div class="form-group">
                    <label for="inputCode" class="col-sm-2 control-label">描述</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control"  name="taskDesc" placeholder="任务描述" value="{{#dispatchTask}}{{#taskDesc}}{{.}}{{/taskDesc}}{{/dispatchTask}}">
                        {{#taskDescErr}}<span class="error">{{.}}</span>{{/taskDescErr}}
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="col-sm-offset-2 col-sm-10">
                        <input type="submit" class="btn btn-primary" value="提 交"/>
                        <a href="{{ctx.contextPath}}/task/dispatch/list" class="btn btn-default">返 回</a>
                    </div>
                </div>
                <input type="hidden" name="splitSubTaskJson" id="subTaskJson" value="{{#splitSubTaskJson}}{{.}}{{/splitSubTaskJson}}"/>
            </form>
        </div>
    </div>
</div>
<script src="{{ctx.contextPath}}/js/jquery-1.11.3.min.js"></script>
<script src="{{ctx.contextPath}}/js/bootstrap.min.js"></script>
<script>
$(function() {
    $('#splitTaskId').val({{#dispatchTask}}{{#splitTask.id}}{{.}}{{/splitTask.id}}{{/dispatchTask}});
    var tz_splitTaskId = '{{#tz_splitTask}}{{tz_splitTask.id}}{{/tz_splitTask}}';
    if(tz_splitTaskId)$('#splitTaskId').val(tz_splitTaskId);
    changeSplitTask(true,tz_splitTaskId);
});

var subTask_json = [];
function changeSplitTask(first,tz_splitTaskId){
    var splitTaskId = $('#splitTaskId').val();
    if(tz_splitTaskId)splitTaskId = tz_splitTaskId;
	$.ajax({
        url: "/task/split/" + splitTaskId + "/subTask",
        type: "POST",
        async: true,
        dataType: "JSON",
        success: function(data){
        	$('#subTask_div').html("");
        	subTask_json = data;
        	if(data.length > 0){
            	$.each(data, function(n, obj){
            		putSubTask(obj);
            	})
            }
        	if(first)initCheckbox();
        }
    });
}

function putSubTask(obj){
	var subTask = "";
	if(obj.allowDispatch){
		subTask = "<tr><td><input type='checkbox' id='" + obj.id + "' checked></td><td>";
	}else{
		subTask = "<tr><td><input type='checkbox' id='" + obj.id + "' disabled></td><td>";
	}
	subTask += obj.fileArea.subSystem.name +" [" + obj.fileArea.subSystem.ip + "]</td><td>";
	subTask += obj.fileName + "</td><td>";
	subTask += obj.statusText + "</td><td>";
/* 	subTask += obj.fileArea.x + "</td><td>";
	subTask += obj.fileArea.y + "</td><td>"; */
	subTask += obj.fileArea.width + "</td><td>";
	subTask += obj.fileArea.height + "</td><td></tr>";
	$('#subTask_div').append(subTask);
}

function initCheckbox(){
	var jsonStr = $('#subTaskJson').val();
	if(jsonStr != ''){
		var tempJson = JSON.parse(jsonStr);
		$("input[type='checkbox']").each(function(){
			var splitSubTaskId = $(this).attr("id");
			var isHas = false;
			$.each(tempJson, function(n, obj){
	    		if(obj.id == splitSubTaskId){
	    			isHas = true;
	    		}
	    	});
			if(isHas){
				$(this).prop("checked","checked");
			}else{
				$(this).prop("checked","");
			}
		});
	}
}

function onSubmit(){
	if(confirm("一旦创建成功不可修改，确认提交？")){
		var submit_json = [];
		$("input[type='checkbox']").each(function(){
			var checked = $(this).prop("checked");
			if(checked){
				var splitSubTaskId = $(this).attr("id");
				$.each(subTask_json, function(n, obj){
		    		if(obj.id == splitSubTaskId){
		    			submit_json.push(obj);
		    		}
		    	})
			}
		});
		$('#subTaskJson').val(JSON.stringify(submit_json));
		return true;
	}else{
		return false;
	}
}
</script>
</body>
</html>
