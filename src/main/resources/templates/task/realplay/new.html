<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>新增文件 - 欧司朗视频切割系统</title>
    <link rel="stylesheet" href="{{ctx.contextPath}}/css/bootstrap.css">
    <link rel="stylesheet" href="{{ctx.contextPath}}/css/bootstrapValidator.min.css">
    <link rel="stylesheet" href="{{ctx.contextPath}}/css/bootstrap-multiselect.min.css">
    <!--[if lt IE 9]>
    <script src="{{ctx.contextPath}}/js/vendor/html5shiv.min.js"></script>
    <script src="{{ctx.contextPath}}/js/vendor/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" href="{{ctx.contextPath}}/css/jquery.fileupload.css">
    <link rel="stylesheet" href="{{ctx.contextPath}}/css/bijie.css">
    <style></style>
</head>

<body>

<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container-fluid">
        <div class="navbar-header">
            <a class="navbar-brand" href="#">欧司朗视频切割系统</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
            	<li><a href="#">
            		<span class="badge" id="cpu">CPU: 00.00%</span>
            		<span class="badge" id="mem">MEM: 00.00%</span>
            		<span class="badge" id="disk">DISK: 00.00%</span>
            	</a></li>
                <li><a target="blank" href="{{ctx.contextPath}}/admin/login">高级设置</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container-fluid">
    <div class="row">
        <div class="col-sm-3 col-md-2 sidebar">
            <ul class="nav nav-sidebar">
                <li class="active submenu open">
                    <a href="#">任务管理</a>
                    <ul style="display: block;">
                        <li><a href="{{ctx.contextPath}}/task/split/list">切割任务</a></li>
                        <li><a href="{{ctx.contextPath}}/task/dispatch/list">分发任务</a></li>
                        <li class="active"><a href="{{ctx.contextPath}}/task/realplay/list">实时文件播放任务</a></li>
                    </ul>
                </li>
                <li><a href="{{ctx.contextPath}}/manage/sub_system/list">通用管理</a></li>
            </ul>
        </div>

        <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
            {{#message}}
            <p class="alert {{#hasError}}alert-danger{{/hasError}}{{^hasError}}alert-success{{/hasError}}" role="alert">
            	<a href="#" class="close" data-dismiss="alert">&times;</a><em>系统提示：</em>{{message}}</p>
            {{/message}}
            <div class="page-header">
                <h1>上传新的视频
                    <small>新增</small>
                </h1>
            </div>
            <form class="form-horizontal" method="post" id="form" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="inputCode" class="col-sm-2 control-label">视频文件</label>
                    <div class="col-sm-10">
	                    <label class="btn btn-primary fileinput-button" style="width:200px" data-placement="auto right" data-trigger="manual">
	                 		<i class="glyphicon glyphicon-upload"></i>
	                    	<span>视频文件选择</span>
	               			<input type="file" name="file" accept="video/x-ms-wmv,video/mp4" required>
	                     </label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="inputCode" class="col-sm-2 control-label">文件描述</label>
                    <div class="col-sm-10">
                    	<textarea class="form-control" name="fileResource.fileDesc" placeholder="文件描述" rows="5" maxlength="100" required>{{#realplayTask}}{{#realplayTask.fileResource}}{{#realplayTask.fileResource.fileDesc}}{{.}}{{/realplayTask.fileResource.fileDesc}}{{/realplayTask.fileResource}}{{/realplayTask}}</textarea>
                        {{#fileResource.fileErr}}<span class="error">{{.}}</span>{{/fileResource.fileErr}}
                    </div>
                </div>
                <div class="form-group">
                    <label for="inputCode" class="col-sm-2 control-label">任务密码</label>
                    <div class="col-sm-10">
                        <input type="password" class="form-control"  name="taskPassword" placeholder="任务密码" required>
                        {{#taskPasswordErr}}<span class="error">{{.}}</span>{{/taskPasswordErr}}
                    </div>
                </div>
                <div class="form-group">
                    <label for="inputCode" class="col-sm-2 control-label"></label>
                    <div class="col-sm-10">
                        <input type="checkbox" name="fileResource.goPlay" {{#realplayTask}}{{#fileResource.goPlay}}checked{{/fileResource.goPlay}}{{/realplayTask}}>
                        立即播放
                        {{#goPlayErr}}<span class="error">{{.}}</span>{{/goPlayErr}}
                    </div>
                </div>
                <div id="play_div" style="display:none">
	                <div class="form-group">
	                    <label for="inputName" class="col-sm-2 control-label">选择切割模板</label>
	                    <div class="col-sm-10">
	                        <select class="form-control" name="splitTemplate.id" id="templateId" required>
	                        	{{#templates}}
	                        	<option value="{{id}}" {{#isDefault}}style="font-weight:bold;"{{/isDefault}} data-type="{{type}}">{{name}}</option>
	                        	{{/templates}}
	                        </select>
	                    </div>
	                </div>
	                <div class="form-group" id="ecueBox" style="display: none">
	                    <label for="inputName" class="col-sm-2 control-label">选择ECUE设备</label>
	                    <div class="col-sm-10">
	                    	<select id="subSystemIds" name="subSystemIds" multiple="multiple" required>
	                        	{{#subSystems}}
	                        	<option value="{{id}}">{{name}} [{{ip}}]</option>
	                        	{{/subSystems}}
	                        </select>
	                    </div>
	                </div>
	                <div class="form-group">
	                    <label for="inputCode" class="col-sm-2 control-label"></label>
	                    <div class="col-sm-10">
	                        <input type="checkbox" name="repeate" {{#realplayTask}}{{#repeate}}checked{{/repeate}}{{/realplayTask}}>
	                        循环播放
	                        {{#repeateErr}}<span class="error">{{.}}</span>{{/repeateErr}}
	                    </div>
	                </div>
                </div>
                <div class="form-group">
                    <div class="col-sm-offset-2 col-sm-10">
                        <input type="submit" class="btn btn-primary" value="提 交"/>
                        <a href="{{ctx.contextPath}}/task/realplay/list" class="btn btn-default">返 回</a>
                        <span id="submiting"></span>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<script src="{{ctx.contextPath}}/js/jquery-1.11.3.min.js"></script>
<script src="{{ctx.contextPath}}/js/bootstrap.min.js"></script>
<script src="{{ctx.contextPath}}/js/bootstrapValidator.min.js"></script>
<script src="{{ctx.contextPath}}/js/bootstrap-multiselect.min.js"></script>
<script>
var formData;
$(function() {
	//选择文件后提交
    $(".fileinput-button").on("change", "input[type='file']", function() {
    	var fileName = $("input[name='file']").val();
    	fileName = fileName.substr(fileName.lastIndexOf("\\")+1);
    	if(fileName != ''){
	    	$('.fileinput-button').attr('data-original-title',fileName);
	    	$('.fileinput-button').tooltip("show");
    	}else{
	    	$('.fileinput-button').tooltip("hide");
    	}
    });
    $("input[name='fileResource.goPlay']").on("change",function(){
    	changeGoPlay();
    });
    $('#subSystemIds').multiselect({nonSelectedText: '未选择'});
	$('#templateId').on("change",function(){
		var type = $(this).find("option:selected").attr("data-type");
		if(type === "1"){
			$('#ecueBox').show();
		}else{
			$('#ecueBox').hide();
		}
	});
	$('#templateId').val({{#realplayTask}}{{#realplayTask.splitTemplate}}{{realplayTask.splitTemplate.id}}{{/realplayTask.splitTemplate}}{{/realplayTask}});
    $("#form").bootstrapValidator({
   		fields:{taskPassword:{validators:{
			remote:{
					url : '/task/valid/pwd',
					message : "任务密码不正确",
					type : 'POST',
                    delay: 1000
				}}}}
    }).on('success.form.bv', function (e) {
        e.preventDefault();
        goSubmit();
    });
    formData = $("#form").data('bootstrapValidator');
    changeGoPlay();
});

function changeGoPlay(){
	if($("input[name='fileResource.goPlay']").prop("checked")){
		$('#play_div').show(200);
	}else{
		$('#form').bootstrapValidator('disableSubmitButtons', false);
		$('#play_div').hide(200);
	}
}

function goSubmit(){
	if(confirm("一旦创建成功不可修改，确认提交？")){
		$("#submiting").html("<img src='/css/img/small-loading.gif'>上传中,请稍后...");
		$("input[name='taskPassword']").val($.md5($("input[name='taskPassword']").val()));
		formData.disableSubmitButtons(true).defaultSubmit();
	}else{
		$('#form').bootstrapValidator('disableSubmitButtons', false);
	}
}
</script>
</body>
</html>
